
## メトリックアラート

### アラートルールの作成

アラートは以下のようにして作成

- **リソース**
  - アラート ルールに使用するターゲット リソース
  - 1 つのアラート ルールに複数のターゲット リソースを割り当てることが可能
  - リソースの種類によって、使用できるシグナルの種類が決まる
- **条件**
  - ルールの評価に使用されるシグナルの種類
    - シグナルの種類には、メトリック、アクティビティ ログ、またはログを使用
  - シグナルの種類によって指定されたデータに適用されるアラート ロジック
    - アラート ロジックの構造は、シグナルの種類によって変わる
- **アクション**
  - アクションは、メールの送信、SMS メッセージの送信、または Webhook の使用と似ています。
  - アクション グループ。通常、アクションの受信者の一意のセットが含まれています。
- **アラートの詳細**
  - アラート名と、アラートの目的が指定されたアラートの説明。
  - 条件またはロジック テストが true と評価された場合のアラートの重大度。 重大度レベルには次の 5 つがあります
    - 0:重大
    - 1:エラー
    - 2:警告
    - 3:情報
    - 4:詳細

### アラートルールの範囲

- ほとんどの Azure サービスから監視データを取得し、Azure Monitor パイプラインを使用してレポートすることが可能
- Azure Monitor パイプラインでは、次のような項目に対してアラート ルールを作成
  - メトリック値
  - ログの検索クエリ
  - アクティビティ ログのイベント
  - 基になっている Azure プラットフォームの正常性
  - Web サイトの可用性のテスト

### アラートのステータス

- **新規**
  - 新しいアラートの状態はすべて、[新規] になります。 この状態は、問題が検出されているがまだ確認されていないことを意味します。
- **確認済み**
  - 認知管理者がアラートを確認し、対応中になると、アラートの状態は [確認済み] に変わります。
- **解決済み**
  - 問題が解決されると、アラートの状態は [解決済み] に設定されます。

### CLI

```sh
az monitor metrics alert create \
    -n "Cpu80PercentAlert" \
    --resource-group [sandbox resource group name] \
    --scopes $VMID \
    --condition "max percentage CPU > 80" \
    --description "Virtual machine is running at or greater than 80% CPU utilization" \
    --evaluation-frequency 1m \
    --window-size 1m \
    --severity 3
```

## ログアラート

ログ アラートでは、ログ データを使用してルール ロジックが評価され、必要に応じてアラートがトリガーされます。 このデータは、任意の Azure リソース (サーバー ログ、アプリケーション サーバー ログ、またはアプリケーション ログ) から取得することが可能

ログアラートでは以下を指定した作成する

- **ログ クエリ**
  - アラート ルールが実行されるたびに実行されるクエリ。
- **期間**
  - クエリの時間範囲。
- **頻度**
  - クエリの実行頻度。
- **しきい値**
  - アラートが作成されるトリガー ポイント

上記の検索の結果は、レコード数またはメトリック測定の2種類のいずれかになる。

### レコード数

クエリの結果のレコード数で判断される

### メトリック測定

メトリック測定ログでは、追加の条件を設定する必要があり

- **集計関数**
  - 結果データに対して実行される計算。 たとえば、count や average などです。 関数の結果は AggregatedValue と呼ばれます。
- **グループ フィールド**
  - 結果がグループ化されるフィールド。 この条件は、集計値と組み合わせて使用されます。 たとえば、平均をコンピューター別にグループ化するように指定できます。
- **間隔**
  - データを集計する時間の間隔。 たとえば、10 分を指定した場合、10 分の集計されたブロックごとにアラート レコードが作成されます。
- **しきい値**
  - 集計値と違反の合計数で定義されるポイント。

## アクティビティログアラート

- アクティビティ ログ アラートには、次の 2 種類
  - 特定の操作
    - Azure サブスクリプション内のリソースに適用
    - サブスクリプションの一部に対する変更を報告するアラートを受け取る必要がある場合に使用
      - たとえば、仮想マシンが削除された場合、または新しいロールがユーザーに割り当てられた場合に、アラートを受け取る、等
  - サービス正常性イベント:ターゲット リソースのインシデントとメンテナンスの通知が含まれます。
- アクティビティ ログ アラートでは、ログ アラートが作成されたサブスクリプションのイベントのみが監視される
  
### アクティビティログアラートの構成

- **カテゴリ**
  - 管理、サービス正常性、自動スケール、ポリシー、または推奨。
- **スコープ**
  - リソース レベル、リソース グループ レベル、またはサブスクリプション レベル。
- **リソース グループ**
  - アラート ルールを保存する場所。
- **リソースの種類**
  - アラートのターゲットの名前空間。
- **操作名**
  - 操作の名前。
- **レベル**
  - 詳細、情報、警告、エラー、または重大。
- **状態**
  - 開始済み、失敗、または成功。
- **イベント開始者**
  - ユーザーのメール アドレスまたは Azure Active Directory 識別子 ("呼び出し元" と呼ばれます)。

## サービス正常性アラート

![picture 9](images/4900f08a925699e70e9c237696d634816225b26815d18cf9d590ed75a37ae827.png)  


## アラートが発生した時のアクションの実行

以下のようなアクションを実行可能

- メールを送信する
- SMS メッセージを送信する
- Azure アプリのプッシュ通知を作成する
- 番号を指定して音声通話を行う
- Azure 関数を呼び出す
- ロジック アプリをトリガーする
- Webhook への通知を送信する
- ITSM チケットを作成する
- Runbook を使用する (VM を再起動する場合、または VM をスケールアップまたはスケールダウンする場合)

こんなメールがくる
![picture 11](images/4381bfe91880e465ce2126df884fef1db6baee11c939d89850f5f003b3077421.png)  

## スマートグループ

多数のアラートが上がって手に負えなくなったような場合は、スマートグループを利用するとよい

スマート グループは、Azure Monitor の自動機能です。 機械学習アルゴリズムを使用することで、Azure Monitor により反復する発生や類似性に基づいてアラートがグループ化されます。 スマート グループを使用すると、アラートごとではなく、アラートのグループに対処できます。

![picture 10](images/90be18652ea55edd151957d46b7ffebb6b5d1aa0399b808e83fc8daa8027627c.png)  
