# Network WatcherによるNWの監視とトラブルシューティング

ネットワークの監視、診断、分析、トラブルシュートについて。
主にNetwork Watcherを使用する。

## Network Watcherとは

Azureネットワークの正常性を診断するサービス。以下2つのカテゴリに分類される。

- 監視（3つの監視ツール）
- 診断（6つの診断ツール）

- 地域サービスであるので、リージョン単位で有効・無効にする
- メトリックの監視、診断、レビュー、およびログの有効化または無効化を行うツールを提供
- エンドツーエンドネットワークレベルビューで問題を診断できるように、シナリオレベルの監視を提供 

メニュー

![picture 12](images/fd8395706f73b33b560bbc1bea3a256a63d164be5fbd11ed24f82b21f01f6909.png)  


## Network Watcherの**監視**ツール

### 1. トポロジツール

ネットワークの**リソース、相互接続**、をグラフィカルに表示
トポロジを生成するには、仮想ネットワークと同じリージョンに Network Watcher インスタンスが必要

### 2. 接続モニター

Azure リソース間の**接続が機能していることを確認**する。2 つの VM が通信できることをこのツールを使用して確認。
リソース間の待機時間も測定。接続モニターでは、VM の監視に加えて、IP アドレスまたは完全修飾ドメイン名 (FQDN) を調べることも可能。

### 3. Network Performance Monitor

**待機時間とパケットの破棄を追跡**。
Network Performance Monitor を使用して、**エンドポイント間の接続**を監視できます。

- 分岐とデータセンター間
- 仮想ネットワーク間
- **オンプレミスとクラウド間の接続**
- Azure ExpressRoute 回線

![picture 13](images/deed7978004f8ac78a9fbc3800c7d982981fea9aa0a7e1affd5e92f78ad2a5ff.png)  


## Network Watcherの**診断**ツール

### 1. IP フロー検証

- 特定の仮想マシンに対して**パケットが許可または拒否**されているかどうかを示す
- インターネットとオンプレミス環境との接続の問題を診断します。セキュリティルールが正しく適用されていることを確認するのに最適

![picture 14](images/2cb910848d92070b7363d1b830230f77bd6a5404b435a1e33c2e1913dff810c4.png)  

### 2. 次ホップ

- VM から任意の宛先への**パケットの移動方法**を決定することができます
- 送信元 VM、送信元ネットワーク アダプター、送信元 IP アドレス、および送信先 IP アドレスを指定します。 そうすると、ツールによってパケットの送信先が決定されます
- このツールを使用すると、不正確なルーティング テーブルに起因する問題を診断

### 3. NSG フローログ セキュリティ グループ ビュー

- NSGの有効性を確認する
- NSG を介した入力および出力 IP トラフィックに関する情報を表示する
- フローログは JSON 形式で書き込まれ、ルールごとに送信フローと着信フローを表示します
- JSON 形式は、Power BI または Kibana のようなサードパーティ製ツールで視覚的に表示できます

### 4. パケット キャプチャ

- VM 間で送受信されたすべてのパケットを記録するには、パケット キャプチャ ツールを使用
- その後、キャプチャされたものを確認して、ネットワーク トラフィックに関する統計情報を収集したり、プライベート仮想ネットワークの予期しないネットワーク トラフィックなどの異常を診断したりできる
- 既定の使用制限は、リージョンあたり 100 パケット キャプチャ セッションで、全体の上限は 10,000 
- パケット キャプチャは、VM にインストールされている **Network Watcher エージェント VM 拡張機能**に依存

### 5. 接続のトラブルシューティング

- 送信元と送信先の VM 間の TCP 接続を確認するために使用します。 送信先 VM は、FQDN、URI、または IP アドレスを使用して指定
- 送信元 VM と宛先間の接続を確認する
- 到達可能性に影響を与える構成の問題を特定する
- ソースから宛先へのすべての可能なホップバイホップパスを提供する
- ソースと宛先の間の最小、最大、平均のホップバイホップの待ち時間を確認する
- ソースから宛先までのグラフィカルトポロジを表示する

### 6. VPN のトラブルシューティング

- 仮想ネットワーク ゲートウェイ接続に関する問題を診断
- ゲートウェイと接続のトラブルシューティングに役立ちます
- 概要情報と詳細情報を提供します
- 複数のゲートウェイまたは接続を同時にトラブルシューティングできます

## ユースケース

### 単一のVMにだけ問題がある場合

まずは接続を調査するひつようがあるので、**IPフロー検証**をを行うとよい

### 指定された宛先ポートでListenしているサーバーがない


![picture 15](images/6c11193d7402d0942e35951b058d881d502c5095fc1b2d8b9e0ad345e029985f.png)  
