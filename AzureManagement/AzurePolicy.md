# Policyの付与に関するメモ

https://docs.microsoft.com/ja-jp/azure/governance/policy/concepts/effects

Azure Policy は、ポリシーの作成、割り当て、管理に使用できるサービス 。このポリシーは、リソースが作成されるときにこれらの規則を強制したり、既存のリソースの有効性を確認し、規則に従っていることを判断したりする際に使用される。

## Policyの適用方法

1. JSON形式でポリシー定義を作成する
   1. ポリシー をグループ化したイニシアチブも作成可能
2. 任意のスコープでポリシーの割り当て

## リソースが評価されるタイミング

- リソースが、作成・更新・削除される
- ポリシーおよびイニシアチブが新規で割り当てられる
- 割り当て済みポリシーおよびイニシアチブが更新される
- 標準のコンプライアンス評価サイクルで24時間毎に実行される

## 評価結果への対応

対応方法は以下の通り

- リソースの変更を拒否
- リソースへの変更をログに記録
- 変更前にリソースを変更
- 変更後にリソースを変更
- 準拠している関連リソースをデプロイする

これらは、`効果`を適用して制御される
準拠していないリソースを`修復`することも可能

## 効果

https://docs.microsoft.com/ja-jp/azure/governance/policy/concepts/effects

効果は以下の通り

- Append
  - 追加のプロパティなどを設定する
- Audit
  - 非準拠の場合にログにイベント作成、要求は停止しない
- AuditIfNotExists
  - 条件に合致しない場合にAudit
- Deny
  - 拒否する
- DeployIfNotExists
  - 条件に合致しない場合に実行
- Disabled
- EnforceOPAConstraint (プレビュー)
- EnforceRegoPolicy (プレビュー)
- Modify

## 評価の順序

まず、リソースに適用される割り当ての一覧が作成された後に、リソースが評価される。

1. **Disable**で評価の必要を確認
2. **Append** と **Modify**
3. **Deny**
4. **Audit**

リソース プロバイダーによって成功コードが返された後、AuditIfNotExists と DeployIfNotExists が評価され、追加のコンプライアンスのログ記録またはアクションが必要かどうかが判断されます。

## ポイント

- ポリシーの評価の際には、Disableが最初に評価されてそのルールが適用されるか検査される
  - Disabled、 Append、Deny, Audit
- Appendは、既存のフィールドの値を変更するものではなく、フィールドを追加するもの。フィールドが既にある場合、リソースにフィールドが既にあって、値とポリシーが異なる場合に、リジェクトするように働く。
- Auditは、不整合がある場合にActivityログに書き込みを行う。
- DeployIfNotExistsは、ステータスコードがSuccessを返した場合に評価される。リソースが存在しない場合、存在状況がfalseの場合に適用される
