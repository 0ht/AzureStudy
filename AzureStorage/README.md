# Azure Storage

## VM 用のストレージの概要

- すべての Azure 仮想マシンには、少なくとも 2 個の仮想ハード ディスク (VHD) があり
  - 1 つ目のディスクにはオペレーティング システムが格納され
  - 2 つ目のディスクは一時ストレージとして使用
  - 最大数は、選択した VM サイズによって異なる (通常は CPU ごとに 2 個)

- 各VHD のデータは、Azure Storage にページ BLOB として保持
  - ストレージ アカウントは、特定のサブスクリプション向けに、Azure Storage 内のオブジェクトへのアクセスを提供
  - Standard または Premium ストレージ
    - Azure Premium Storage
      - ソリッド ステート ドライブ (SSD) を利用して、I/O を集中的に行うワークロードを実行する VM に対して、高パフォーマンス＆Low Latencyアクセスを提供
      - 本番運用環境のワークロードに使用するとよい。特に、パフォーマンスの変動の影響を受けやすいワークロードや、I/O を集中的に行うワークロードに向いている
    - 開発またはテスト用には、Standard ストレージで十分

- アンマネージド ディスクまたはマネージド ディスク
  - アンマネージド ディスク  
    アンマネージド ディスクを使用する場合、VM ディスクに対応する VHD を保持するために使用するストレージ アカウントを自分で管理する必要があります。 使用する領域の容量に対するストレージ アカウントの料金を支払います。 1 つのストレージ アカウントには、I/O 操作数 20,000/秒という固定レート制限があります。これは、1 つのストレージ アカウントが最大使用率で 40 個の標準仮想ハード ディスクをサポートできることを意味します。 ディスクを増加してスケールアウトする必要がある場合は、ストレージ アカウントを増やす必要があり、複雑になる可能性があります。  

  - マネージド ディスク  
    マネージド ディスクは、より新しい、お勧めのディスク ストレージ モデルです。 ストレージ アカウントを管理する負担を Azure に移すことで、この複雑さを適切に解決します。 4 TB までのディスク サイズを指定します。Azure により、ディスクとストレージの "両方" が作成、管理されます。 ストレージ アカウント制限について気にする必要がないため、マネージド ディスクは簡単にスケールアウトできます。

    貼り付け元  <https://docs.microsoft.com/ja-jp/learn/modules/intro-to-azure-virtual-machines/2-compile-a-checklist-for-creating-a-vm> 

## ディスクの種類

- **Ultra**  
  VM再起動なしでパフォーマンスを動的に変更可能。SAP HANA、最上位のDB、高トランザクション用。データディスクのみ。OSはPremiumと併用  

- **Premium SSD**  
  シリーズにsが含まれるVMで利用可能  

- **Standard SSD**  
  Standard HDDとPremium SSDの中間  

- **Standard HDD**  
  すべてのVMサイズで利用可能コスト安  

## マネージドの利点

- **信頼性の向上**  
  Azure では、高信頼性の VM に関連付けられた VHD が Azure Storage のさまざまな部分に配置されて、同等のレベルの回復力が提供されます。
  
- **セキュリティの向上**  
  マネージド ディスクは、リソース グループ内の管理対象リソースです。 つまり、ロールベースのアクセス制御を使用して、VHD データを使用できるユーザーを制限することができます。

- **スナップショット サポート**  
  スナップショットは、VHD の読み取り専用コピーの作成に使用できます。 所有している VM をシャットダウンする必要がありますが、スナップショットの作成に要する時間はわずか数秒です。 完了したら、VM の電源を入れ、スナップショットを使用して重複する VM を作成し、運用環境の問題をトラブルシューティングしたり、スナップショットが作成された時点に VM をロールバックしたりできます。

- **バックアップのサポート**  
  Azure Backup を使用して、VM のサービスに影響を与えることなく、ディザスター リカバリーのために、マネージド ディスクを異なるリージョンに自動的にバックアップできます。

## データのレプリケーション

- **ローカル冗長ストレージ (LRS)**  
  同じ Azure データ センター内でデータがレプリケートされます。 ノードで障害が発生しても、データは引き続き使用できます。 ただし、データ センター全体で障害が発生すると、データが使用できなくなる場合があります。

- **geo 冗長ストレージ (GRS)**  
  プライマリ リージョンから数百マイル離れた第 2 のリージョンにデータがレプリケートされます。 ご利用のストレージ アカウントで GRS が有効になっている場合、地域的な停電やプライマリ リージョンが復旧できない災害が発生しても、データは保持されます。

- **読み取りアクセス geo 冗長ストレージ (RA-GRS)**  
  セカンダリ ロケーションにあるデータに対する読み取り専用アクセス、および 2 つのリージョンにまたがる geo レプリケーションが提供されます。 データ センターで障害が発生しても、データは引き続き読み取り可能ですが、変更できなくなります。

- **ゾーン冗長ストレージ (ZRS)**  
  1 つのリージョン内の 3 つのストレージ クラスターにデータが同期的にレプリケートされます。 各ストレージ クラスターは物理的に他のストレージ クラスターと分離されており、それぞれの可用性ゾーン (AZ) 内にあります。 この種類のレプリケーションでは、ゾーンが使用できなくなっても、お使いのデータには引き続きアクセスし、管理することができます。

## ディスクのパフォーマンス

貼り付け元  <https://docs.microsoft.com/ja-jp/learn/modules/add-and-size-disks-in-azure-virtual-machines/4-choosing-premium-storage> 

## 仮想マシンのディスクサイズを変更する

流れとしては、

1. VMを停止して割り当てを解除
2. 変更後は同じくパーティション拡張などをシェルを介して実行する（VM拡張としてシェル呼び出しするとよい）

## Azure 内のディスク パフォーマンスに対するキャッシュの影響

秒あたりのIO
ディスクにより特性が決まっている。
VMにも最大値の制限が存在する。
実際には、スループットと待機時間が関係するのでもっと少なくなる。

スループット
秒あたりの帯域幅
IOPS x I/O size = throughput
なので、I/Oサイズを適切に切る必要がある。

待機時間
応答を待つ時間、処理がブロックされる

ディスクパフォーマンスのテスト
iometerなどでテストする

デイスクキャッシュの有効化
読み取りキャッシュ

## Windows および Linux VM を保護するための暗号化オプション

- **Storage Service Encryption (SSE)**  
  - Azure に組み込まれている暗号化サービス
  - 256 ビット AES 暗号化を使用する暗号化が既定で有効になっており、ストレージ アカウント管理者によって管理

- **Azure Disk Encryption (ADE)**  
  - Azure Disk Encryption (ADE) は、VM の所有者によって管理
    - Windows VM では BitLocker を使用し
    - Linux VM では DM-Crypt を使用
  - ADE は Recovery コンテナーにバックアップされる VM では必須
    - ADE は、これらのディスク暗号化キーとシークレットを管理するために Azure Key Vault と統合

### 既存のVMディスクの暗号化

1. キー コンテナーを作成
2. ディスク暗号化をサポートするようにキー コンテナーのアクセス ポリシーを設定します。
3. キー コンテナーを使用して、ADE の暗号化キーを格納します。
4. ディスクの暗号化を実施  OS、データ、両方、を選択

- Azure Disk Encryption では、暗号化シークレットがリージョン境界を越えることがないため、キー コンテナーと VM が同じ Azure リージョンにある必要があり
- Standard または Premium のいずれかの価格レベルを選択できます。 主な違いは、Premium レベルではハードウェア暗号化のバックアップ キーを使用できる点
