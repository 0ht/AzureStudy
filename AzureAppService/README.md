# Azure App Service を知る

## 概要

Web アプリケーション、REST API、およびモバイル バックエンドをホストするための HTTP ベースのサービス。  
開発言語は以下を利用可能。

- .NET
- .NET Core
- Java
- Ruby
- Node.js
- PHP
- Python

- Win：NET Core3.1, **ASP.NET 4.7**, PHP 7.3, Node.js, Java
- Linux：.NET Core3.1, **Ruby 2.6**, PHP, Node.js, Java, **Python**

WindowsベースとLinuxベースがある。
セキュリティ、負荷分散、自動スケーリング、自動管理などの Microsoft Azure の機能を、アプリケーションに追加
Azure DevOps、GitHub、Docker Hub およびその他のソースからの継続的デプロイ、パッケージ管理、ステージング環境、カスタム ドメイン、TLS/SSL 証明書など、DevOps 機能も利用可能。

使用した Azure コンピューティング リソースに応じて課金、アプリが実行されている "App Service プラン" によって決定される。

## App Service プラン

- VMを抽象化したもの。パッケージ、環境、等の運用機能をまとめたものとも考えることができる。
- App Service プランでは、Web アプリを実行するための一連のコンピューティング リソースを定義
- このプランに導入したアプリは、そのプラン定義にしたがって実行される。プランには、以下が定義される
  - リージョン (米国西部、米国東部など)
  - VM インスタンスの数
  - VM インスタンスのサイズ (小、中、大)
  - 価格レベル (Free、Shared、Basic、Standard、Premium、PremiumV2、Isolated)

https://azure.microsoft.com/ja-jp/pricing/details/app-service/windows/

- Free と Shared のレベルでは、アプリは共有 VM インスタンス上の CPU 時間 (分) を受け取り、スケールアウト不可
  - App Service Freeプランでは、60 CPU Time/day,  Sharedでは240 CPU Time/dayの制限がある
- アプリを実行すると、App Service プランで構成されているすべての VM インスタンスで実行
  - 複数のアプリが同じ App Service プランにある場合、これらはすべて同じ VM インスタンスを共有
  - App Service プランは App Service アプリのスケール ユニット

 | FREE 無料で試す | Shared 開発/テスト用の環境 | BASIC 開発/テスト専用の環境 | STANDARD 運用環境のワークロードの実行 | PREMIUM 強化されたパフォーマンスとスケール | ISOLATED ハイパフォーマンス、セキュリティおよび分離
-|--------------------------|---------------------------------------------------------------------|--------------------------------|--------------------------------|--------------------------------|-------------------------------
Web、Mobile、API、API Apps | 10 | 100 | 無制限 | 無制限 | 無制限 | 無制限
ディスク領域 | 1 GB | 1 GB | 10 GB | 50 GB | 250 GB | 1 TB
最大インスタンス数 | – | – | **最大 3** | 最大 10 | 最大 30* | 最大 100
カスタム ドメイン | – | **サポート対象** | サポート対象 | サポート対象 | サポート対象 | サポート対象
自動スケール | – | – | – | サポート対象 | サポート対象 | サポート対象
ハイブリッド接続 | – | – | **サポート対象** | サポート対象 | サポート対象 | サポート対象
仮想ネットワーク接続 | – | – | – | **サポート対象** | サポート対象 | サポート対象
コンピューティングの種類 | Shared | Shared | Dedicated | Dedicated | Dedicated | Isolated
料金 | Free | ¥1.456/時間 | ¥8.40/時間 | ¥11.200/時間 | ¥22.400/時間 | ¥44.800/時間

### 価格レベルでの分類

- 共有コンピューティング
  - 2 つの基本レベルである Free と Shared
  - 他のお客様のアプリを含む他の App Service アプリと同じ Azure VM 上でアプリを実行します。
  - これらのレベルは共有リソースで実行される各アプリに CPU クォータを割り当て、リソースはスケールアウトできません。
- 専用のコンピューティング
  - Basic、Standard、Premium、PremiumV2
  - アプリを専用の Azure VM 上で実行します。
  - 同じ App Service プラン内のアプリのみが同じコンピューティング リソースを共有します。 レベルが高いほど、スケールアウトに使用できる VM インスタンスが多くなります。
- Isolated(=AppService Environment)
  - 専用の Azure 仮想ネットワーク上で専用の Azure VM が実行されます。
  - アプリに対して、コンピューティングの分離の上にネットワークの分離を提供されます。 最大のスケールアウト機能を提供します。

### コスト

- Shared レベル
  - それぞれのアプリが CPU の分単位のクォータを受け取るので、"各アプリ" は **CPU クォータの時間単位で課金**
- 専用コンピューティング レベル (Basic、Standard、Premium、PremiumV2)
  - App Service プランはアプリがスケールされる VM インスタンスの数を定義するので、App Service プランの "各 VM インスタンス" には時間単位の料金があります。
  - これらの VM インスタンスには、実行されているアプリの数にかかわらず**同じ料金が課金**されます。 予期しない課金を避けるには、App Service プランのクリーンアップに関するページをご覧ください。
- Isolated レベル
  - App Service Environment は、アプリを実行する分離された worker の数を定義し、**"各 worker" は時間単位で課金**されます。
  - さらに、App Service Environment 自体の実行に時間単位の基本料金があります。

使用可能な App Service 機能 (カスタム ドメインの構成、TLS/SSL 証明書、デプロイ スロット、バックアップなど) の使用には**課金されません**。ただし、次のような例外があります。

- App Service ドメイン - Azure での購入時と毎年の更新時に支払います。
- App Service 証明書 - Azure での購入時と毎年の更新時に支払います。
- IP ベースの TLS 接続 - IP ベースの TLS 接続ごとに時間単位の課金がありますが、Standard 以上の一部のレベルでは、1 つの IP ベースの TLS 接続が無料で提供されます。 SNI ベースの TLS 接続は無料です。

### プランの変更

- App Service プランは、いつでもスケールアップまたはスケールダウン可能
- アプリが他のアプリと同じ App Service プランにある場合は、コンピューティング リソースを分離すると、アプリのパフォーマンスが向上
- 課金はプラン単位なので、複数のアプリがある場合、同じプランにするとコスト節約の可能性あり
- 分離の指針は以下の通り
  - アプリが多くのリソースを消費している。
  - 既存のプランの他のアプリから独立してアプリをスケーリングする必要がある。
  - アプリに別の地理的リージョン内のリソースが必要である。

## 使用可能なOS機能

https://docs.microsoft.com/ja-jp/azure/app-service/operating-system-functionality

FreeとShared以外の価格プランでは、専用のVMが払いだされる。
以下は、利用可能なOS機能

### ファイルアクセス

### ネットワークアクセス

### コードの実行・プロセス・メモリ

### 診断ログとイベント

### レジストリアクセス

## デプロイ

https://docs.microsoft.com/ja-jp/azure/app-service/deploy-best-practices

### デプロイのコンポーネント

- ソース
- ビルドパイプライン
- デプロイメカニズム

### デプロイスロット

- アプリの実行のコンテキスト？のようなもの。例えば、ステージング、本番、などを用意する。
- 自動でのスワップも可能
- スロット間での割り振りの割合を設定可能
- Standard、Premium、Isolatedで利用可能
- スロットをスワップして、本番環境へのシームレスな切り替えを実現可能
  - スワップは、プレビューで事前確認も可能
- スワップ後はルーティングも自動で切り替わるが、割合を指定して別のスロットへのルーティングを行うことも可能

#### スワップされる設定とされない設定

- スワップされる設定:
  - 一般設定 (フレームワーク バージョン、32/64 ビット、Web ソケットなど)
  - アプリ設定 (スロット固有として構成可能)
  - 接続文字列 (スロット固有として構成可能)
  - ハンドラー マッピング
  - パブリック証明書
  - Web ジョブ コンテンツ
  - ハイブリッド接続 *
  - Virtual Network 統合 *
  - サービス エンドポイント *
  - Azure Content Delivery Network *
  - アスタリスク (*) 記号付きの機能は、スワップされない予定です。
- スワップされない設定:
  - 発行エンドポイント
  - カスタム ドメイン名
  - パブリックでない証明書と TLS/SSL 設定
  - スケールの設定
  - Web ジョブ スケジューラ
  - IP 制限
  - 常時接続
  - 診断設定
  - クロスオリジン リソース共有 (CORS)

az webapp deployment create / swap

### コードの継続的なデプロイ

コード管理リポジトリのブランチとスロットを対応付ける。（GitFlowブランチ戦略）
本番には直接デプロイせず、ステージングなどにデプロイした後に、**スワップ**することで無停止で切り替えを行える。ロールバックも同じくスワップするだけ。
コンテナ―の場合は、イメージをレジストリに登録し、レジストリからPULLする（タグ書き換えがトリガー）
  
CI/CDのフレームワークとしては以下がある。

- Azure DevOps
- GitHub Actions
- Bitbucket
- FTP またはローカル Git リポジトり  と統合可能

### 言語固有の考慮事項

- Java
  - JAR アプリケーションのデプロイには Kudu zipdeploy/ API を使用し、WAR アプリには wardeploy/ を使用
- Node
  - 既定では、Kudu は Node アプリケーションのビルド ステップ (npm install) を実行
  - Azure DevOps などのビルド サービスを使用している場合、Kudu ビルドは不要
  - Kudu ビルドを無効にするには、false の値を指定して SCM_DO_BUILD_DURING_DEPLOYMENT というアプリ設定を作成
- .NET
  - 既定では、Kudu は .NET アプリケーションのビルド ステップ (dotnet build) を実行
  - Azure DevOps などのビルド サービスを使用している場合、Kudu ビルドは不要
  - Kudu ビルドを無効にするには、false の値を指定して SCM_DO_BUILD_DURING_DEPLOYMENT というアプリ設定を作成

### その他の考慮事項

- ローカルキャッシュ
  - 高可用で実行可能な高パフォーマンスの読み取り専用コンテンツ ストアのみが必要になるような場合は、ローカル キャッシュを使うことでメリットが得られる
- CPU・メモリの高使用率
  - 高負荷時のデプロイは失敗する可能性があるので、デプロイ時に一時的にインスタンスをスケールアップするとよい（デプロイ完了したら元に戻す）

### 自動でスケール

 スケールアップ、スケールアウト、スケールダウン可能
クールダウンは、その期間はスケールが行われないという期間を指定する。
スケールアウトのルールを設定したら、スケールインのルールも必ず作成する。
期間を指定してルールを適用することも可能。

Microsoft.insightが登録されていない、というようなエラーが出た場合、サブスクリプションから、リソース・プロバイダーを開き、そこからMicrosoft.Insightsを有効化（登録）する必要がある。

## セキュリティ

## ネットワーク機能

## VNet統合

- VNet統合機能を利用すると、インターネットではなくVNet経由でのみアクセス可能な状態にすることができる。
- 2つのバリエーション
  - Isoatedをのぞくすべての価格プランをサポートするマルチテナントシステム
  - IsolatedのAppService Environment
- アプリから VNet 内のリソースにアクセスできるようになりますが、VNet からそのアプリへの受信プライベート アクセスは付与されない
- 以下の2種
  - リージョン VNet 統合
    - 同じリージョン内の Azure Resource Manager 仮想ネットワークに接続する場合、統合する VNet での専用のサブネットが必要になります。
  - ゲートウェイが必要な VNet 統合
    - 他のリージョン内の VNet または同じリージョン内のクラシック仮想ネットワークに接続する場合、ターゲットの VNet にプロビジョニングされた Azure 仮想ネットワーク ゲートウェイが必要です。

## ハイブリッド接続 Azure Relay

## Trafiic Manager 統合

## マネージドIDを使用したSQL Database接続のセキュリティ保護

https://docs.microsoft.com/ja-jp/azure/app-service/app-service-web-tutorial-connect-msi

## 継続的なデプロイの構成

https://support.atlassian.com/bitbucket-cloud/docs/create-a-repository-in-bitbucket-cloud/

## ログの有効化

https://docs.microsoft.com/ja-jp/azure/app-service/troubleshoot-diagnostic-logs

- Application Logは、Win、Linuxともにappservice file systemに書き込まれるが、**winのみBLOB**に直接書き込みするよう構成できる
- web serverログは、windowsのみ。appservice filesystemにW3C Extended形式で出力可能
- Blob Storage には .NET アプリケーションのログのみ書き込むことができます。 Java、PHP、Node.js、Python のアプリケーション ログは、App Service ファイル システムにのみ保存
  
| Type                           | プラットフォーム   | 場所                                                       | 説明                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| ------------------------------ | ------------------ | ---------------------------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **アプリケーションのログ記録** | **Windows、Linux** | App Service ファイル システムおよび **Azure Storage BLOB** | アプリケーションのコードによって生成されたメッセージがログに記録されます。 メッセージは、選択した Web フレームワークによって、またはお使いの言語の標準ログ パターンを使用してアプリケーションのコードから直接、生成できます。 各メッセージには、次のいずれかのカテゴリが割り当てられます: 重大、エラー、警告、情報、デバッグ、トレース。 アプリケーションのログ記録を有効にするときに、重大度レベルを設定することにより、ログ記録の詳細さを指定できます。 |
| **Web サーバーのログ記録**     | **Windows**        | App Service ファイル システムまたは **Azure Storage BLOB** | W3C 拡張ログ ファイル形式の生 HTTP 要求データ。 各ログ メッセージには、HTTP メソッド、リソース URI、クライアント IP、クライアント ポート、ユーザー エージェント、応答コードなどのデータが含まれます。                                                                                                                                                                                                                                                     |
| **詳細なエラー メッセージ**    | **Windows**        | App Service ファイル システム                              | クライアントのブラウザーに送信された .htm エラー ページのコピー。 セキュリティ上の理由から、詳細なエラー ページを運用環境のクライアントに送信することはできませんが、App Service では、HTTP コード 400 以上のアプリケーション エラーが発生するたびにエラー ページを保存できます。 ページには、サーバーによってエラー コードが返される理由を特定するのに役立つ情報が記録されている場合があります。                                                         |
| **失敗した要求トレース**       | **Windows**        | App Service ファイル システム                              | 要求の処理に使用された IIS コンポーネントのトレースや各コンポーネントにかかった時間など、失敗した要求の詳細なトレース情報。 これは、サイトのパフォーマンスを向上させたり、特定の HTTP エラーを分離したりする場合に役立ちます。 失敗した要求ごとに 1 つのフォルダーが生成され、それには、XML ログ ファイルと、ログ ファイルを表示するための XSL スタイルシートが含まれます。                                                                               |
| **デプロイ ログ**              | **Windows、Linux** | App Service ファイル システム                              | アプリにコンテンツを発行するときのログ。 デプロイ ログの記録は自動的に行われ、デプロイ ログの構成可能な設定はありません。 デプロイが失敗した理由を判断するのに役立ちます。 たとえば、カスタム デプロイ スクリプトを使用している場合は、デプロイ ログを使用して、スクリプトでエラーが発生する理由を特定できることがあります。                                                                                                                              |

### Azure Monitorへのログ送信

新しい Azure Monitor の統合を使用すると、ストレージ アカウント、Event Hubs、および Log Analytics にログを送信するために診断設定 (プレビュー) を作成可能。2020/08時点でPreview
