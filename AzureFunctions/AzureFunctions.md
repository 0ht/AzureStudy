# Azure Functionsとは

## 概要

- Azure Functions はサーバーレス アプリケーション プラットフォーム
- Functions では、組み込みのスケーラビリティが提供され、使用されているリソースに対してのみ料金が請求される
- C#、F#、JavaScript、Python、PowerShell Core など、好みの言語で関数コードを記述することが可能
- NuGet や NPM などのパッケージ マネージャーのサポートも含まれており、ビジネス ロジック内で一般的なライブラリを使用することが可能

### 考慮点

#### 実行時間

- 既定では、Functions に 5 分のタイムアウトが設定されている
- このタイムアウトは、最大 10 分に設定することが可能
- 実行に 10 分以上必要な関数は、VM 上でホストするとよい
  - さらに、サービスが HTTP 要求を介して開始され、その値を HTTP 応答として求める場合は、タイムアウトが 2.5 分にまで制限される
  - Durable Functions と呼ばれるオプションもある。これを使用すると、タイムアウトなしで複数の関数の実行を調整することが可能

#### 実行頻度

- Functionが複数のクライアントによって継続的に実行されることが想定される場合は、必要に応じて使用量を見積もり、Functions を使用するコストを計算することを推奨
  - VM 上でホストする方が安くなる可能性もある
- スケーリング中には、10 秒ごとに関数アプリ インスタンスを 1 つだけ作成でき、合計では最大 200 個のインスタンスを作成可能
- 各インスタンスでは複数の同時実行を提供できるため、1 つのインスタンスで処理できるトラフィックには制限がないことに留意
- トリガーの種類が異なれば、スケーリング要件も異なるため、選択したトリガーとその制限について確認が必要

## サービスプラン

### 従量課金サービス プラン

- Azure のサーバーレス アプリケーション プラットフォームを使用するときに選択するプラン
- 従量課金サービス プランでは、自動スケーリングが提供され、関数が実行されているときのみ課金
- 従量課金プランには、関数の実行に対して構成可能なタイムアウト期間が設定される
  - 既定は 5 分、最長 10 分までのタイムアウトを設定可能

### Azure App Service プラン

- 定義した VM 上で関数が常時稼働し、タイムアウトを避けることが可能
- App Service プランを使用している場合、関数を実行するアプリ リソースを管理する責任があるため、厳密にはサーバーレスではない
- 関数が連続的に使用される場合、あるいは従量課金プランよりも多くの処理能力または実行時間が必要な場合に、このプランを選択する

## ストレージアカウントの要件

- 関数アプリを作成する場合、関数アプリはストレージ アカウントにリンクされている必要がある
- 関数アプリでは、**関数実行の記録や実行トリガーの管理など、内部操作のため**にこのストレージ アカウントが使用される
- 従量課金サービス プランでは、これは**関数コードと構成ファイルが格納される場所**でもある

## トリガー

以下のようなトリガーをサポート

サービス | トリガーの説明
-----|--------
BLOB ストレージ | 新しい BLOB または更新された BLOB が検出されたときに関数を開始
Azure Cosmos DB | 挿入および更新が検出されたときに関数を開始
Event Grid | Event Grid からイベントを受信したときに関数を開始
HTTP | HTTP 要求で関数を開始
Microsoft Graph イベント | Microsoft Graph から受信した Webhook に応答して関数を開始。このトリガーの各インスタンスは、それぞれ Microsoft Graph の 1 つのリソースの種類に応答
Queue Storage | キューで新しい項目を受け取ったときに関数を開始。 キュー メッセージは、関数への入力として提供される
Service Bus | Service Bus キューからのメッセージに応答して関数を開始
Timer | スケジュールに従って関数を開始

## バインド

- バインドは、データとサービスを作成した関数に接続するための宣言型の方法
- バインドに、さまざまなサービスに応答する方法を設定する
  - データ ソースに接続して、接続を管理するために、自分で関数にコードを記述する必要はなく、ユーザーの代わりに、プラットフォームによってその複雑さがバインド コードの一部として処理
  - 実際のコードでは、"入力" バインドからデータを読み取り、"出力" バインドにデータを書き込み
- 各関数には、関数によって処理された入出力データを管理するために、0 個またはそれ以上のバインドを割り当てることが可能
- トリガーは、実行を開始する機能を別途備えた特殊な入力バインドととらえることができる
- Azure には、各種のストレージ サービスとメッセージング サービスに接続するために、多数のバインドがあらかじめ用意されている

以下は、Azure Queue Storage トリガーと Azure Table Storage の出力バインドを使用するサンプル

```Json
{
  "bindings": [
    {
      "name": "order",
      "type": "queueTrigger",
      "direction": "in",
      "queueName": "myqueue-items",
      "connection": "MY_STORAGE_ACCT_APP_SETTING"
    },
    {
      "name": "$return",
      "type": "table",
      "direction": "out",
      "tableName": "outTable",
      "connection": "MY_TABLE_STORAGE_ACCT_APP_SETTING"
    }
  ]
}
```

