# AzureCDNを知る

## 概要

- CDN は、さまざまな地理的な場所で Web サイトのコンテンツをキャッシュする Web サーバーのネットワーク
- 単一のサイトが過負荷になることを防いだり、地理的によりクライアントに近い位置でキャッシュしておくことで、ユーザーにより低遅延で応答を返すことができるようになる。
  - 地理的な距離と、ホップ数が遅延につながる

## CDN の有効化

CDNのSKUによって若干異なるが、有効化の手順は以下の通り

1. CDNプロバイダーとサービス契約を締結。これはポータルを介して行える
2. CDNを構成する
3. キャッシュ対象のコンテンツがCDN URLを使用するようにサイトの実相を変更する

## CDNの仕組み

1. ユーザーのリクエストは、最も近いPOP（Point of Presence）にルーティングされる。
2. POPにキャッシュされたこんてんつが存在しているとそこから応答を返す
3. キャッシュされていない場合、POPはオリジンサーバーにリクエストを行い、コンテンツを取得してユーザーに返す。コンテンツはキャッシュに保管される。

## CDNのSKU

選択可能なSKUは以下の通り。

- Standard Microsoft
- Standard Akamai
- Standard Verizon
- Premium Verizon

価格は、送信されるデータ転送GBに基づく
AZURE CDN 製品の機能を比較する

パフォーマンス機能と最適化 | Standard Microsoft | Standard Akamai | Standard Verizon | Premium Verizon
--------------|--------------------|-----------------|------------------|----------------
動的サイト アクセラレーション | Azure Front Door Service により提供 | ✓ | ✓ | ✓
 | 動的サイトの高速化 - アダプティブ画像圧縮 |  | ✓ |  | 
 | 動的サイト アクセラレーション - オブジェクトのプリフェッチ |  | ✓ |  | 
一般的な Web 配信の最適化 | ✓ | ✓ (平均ファイル サイズが 10 MB より小さい場合には、この最適化の種類を選択します) | ✓ | ✓
ビデオ ストリーミングの最適化 | 一般的な Web 配信経由 | ✓ | 一般的な Web 配信経由 | 一般的な Web 配信経由
大きなファイルの最適化 | 一般的な Web 配信経由 | ✓ (平均ファイル サイズが 10 MB より大きい場合には、この最適化の種類を選択します) | 一般的な Web 配信経由 | 一般的な Web 配信経由
最適化の種類を変更する |  | ✓ |  | 
配信元のポート | すべての TCP ポート | 使用できる配信元ポート | すべての TCP ポート | すべての TCP ポート
グローバル サーバー負荷分散 (GSLB) | ✓ | ✓ | ✓ | ✓
高速消去 | ✓ | ✓ (すべての消去およびワイルドカードによる消去は、現在 Azure CDN from Akamai ではサポートされていません) | ✓ | ✓
アセットの事前読み込み |  |  | ✓ | ✓
キャッシュ/ヘッダーの設定 ( キャッシュ規則を使用) | ✓ (Standard ルール エンジンを使用) | ✓ | ✓ | 
カスタマイズ可能なルール ベースのコンテンツ配信エンジン | ✓ (Standard ルール エンジンを使用) |  |  | ✓ (ルール エンジンを使用)
キャッシュ/ヘッダーの設定 | ✓ (Standard ルール エンジンを使用) |  |  | ✓ (Premium ルール エンジンを使用)
URL のリダイレクト/書き換え | ✓ (Standard ルール エンジンを使用) |  |  | ✓ (Premium ルール エンジンを使用)
モバイル デバイスのルール | ✓ (Standard ルール エンジンを使用) |  |  | ✓ (Premium ルール エンジンを使用)
クエリ文字列のキャッシュ | ✓ | ✓ | ✓ | ✓
IPv4/IPv6 デュアルスタック | ✓ | ✓ | ✓ | ✓
HTTP/2 のサポート | ✓ | ✓ | ✓ | ✓
Security | Standard Microsoft | Standard Akamai | Standard Verizon | Premium Verizon
CDN エンドポイントでの HTTPS のサポート | ✓ | ✓ | ✓ | ✓
カスタム ドメイン HTTPS | ✓ | ✓ 、有効にするには直接 CNAME が必要です | ✓ | ✓
カスタム ドメイン名のサポート | ✓ | ✓ | ✓ | ✓
Geo-filtering | ✓ | ✓ | ✓ | ✓
認証トークン |  |  |  | ✓
DDOS 保護 | ✓ | ✓ | ✓ | ✓
独自の証明書の持ち込み | ✓ |  | ✓ | ✓
サポートされている TLS バージョン | TLS 1.2、TLS 1.0 または 1.1 - 構成可能 | TLS 1.2 | TLS 1.2 | TLS 1.2
分析とレポート | Standard Microsoft | Standard Akamai | Standard Verizon | Premium Verizon
Azure 診断ログ | ✓ | ✓ | ✓ | ✓
Verizon からのコア レポート |  |  | ✓ | ✓
Verizon からのカスタム レポート |  |  | ✓ | ✓
詳細な HTTP レポート |  |  |  | ✓
リアルタイム統計 |  |  |  | ✓
エッジ ノードのパフォーマンス |  |  |  | ✓
リアルタイム アラート |  |  |  | ✓
使いやすさ | Standard Microsoft | Standard Akamai | Standard Verizon | Premium Verizon
Storage、 Web Apps、および Media Services などの Azure サービスと簡単に統合できる | ✓ | ✓ | ✓ | ✓
REST API、.NET、Node.js、または PowerShell を介した管理 | ✓ | ✓ | ✓ | ✓
圧縮の MIME の種類 | 既定値のみ | 構成可能 | 構成可能 | 構成可能
圧縮のエンコード | gzip、brotli | gzip | gzip、deflate、bzip2、brotili | gzip、deflate、bzip2、brotili

## Azure CDNの機能と利点

- **動的サイト アクセラレーション**
  - 静的ファイルの配信を高速化します
  - キャッシュの制御は2つの方法で提供
    - パスとファイルの拡張子で制御
    - クエリ文字列
      - クエリ文字列を無視：クエリが何であろうと、最初にそのパスでアクセスされたコンテンツをTTLが切れるまでキャッシュ
      - クエリ文字列に関するキャッシュをバイパス：キャッシュはせずにすべてオリジンサーバーに転送
      - 一意のURLをすべてキャッシュ：クエリ文字列も含めてURLを一意として扱いそれぞれでキャッシュ（キャッシュ効率は下がるかもしれない）
- **HTTPS カスタム ドメインのサポート**
  - https://www.contoso.com などの、カスタム ドメインへの暗号化された接続を有効にします
  - カスタムドメインを構成するためには、管理しているドメインのCNAMEに、CDNのエンドポイントのURLを指定するとともに、CDN側の設定としてカスタムドメイン名の設定を追加する
  - すでに運用環境にある場合は、cdnverifyというサブドメインを使用してテストできる
- **Azure 診断ログ**
  - コア分析情報を表示し、Azure Storage アカウント、Azure Event Hubs、または Log Analytics ワークスペースにデータを送信します
- **ファイル圧縮**
  - 転送中のバイト数を減らすことで、パフォーマンスを向上させます
  - オリジンサーバー上の圧縮されていないファイルもCDN上で圧縮することも可能
- **geo フィルタリング**
  - 選択された国のコンテンツへのアクセスを許可するかブロックするために特定のパスを使用する、CDN エンドポイントに対する規則を作成します

Microsoft Azure CDN を使用する利点は次のとおりです。

- パフォーマンスが向上し、大きなファイルまたはストリーミングされたファイルでのユーザー エクスペリエンスがよりスムーズになります。
- コンテンツの表示に複数のラウンド トリップを必要とする、アプリケーションでの結果が改善されます。
- グローバルな発表イベントなど、特に負荷が急増した場合に、より大きくスケーリングできます。
- 配信元サーバーへのトラフィックが減ります。

- 通常、CDN は、多くの大きな静的ファイルを採用するテクノロジに最適
- しかし、動的サイトでは、Azure の Standard Microsoft CDN による大きな利点は得られません。

## CDNのコンポーネント

### CDN プロファイル

CDN プロファイルは、1 つまたは複数の CDN エンドポイントのコンテナー
各 CDN エンドポイントでは価格レベルを指定し、POP でキャッシュされたコンテンツへのリンクを提供

### CDN エンドポイント

エンドポイントを作成するときに、確実にエンドポイントの種類を配信元ソースと正確に一致させる必要があります。 たとえば、Azure の静的な Web サイトでは、エンドポイントを "カスタムの配信元" に設定する必要があります。 ストレージ アカウントでは、そのアカウントに一致する CDN を作成できます。

### POP間での伝達時間

プロファイルと価格レベルによって異なる

- Azure CDN Microsoft Standard プロファイルは、通常、10 分で伝達されます
- Azure CDN Verizon Standard および Azure CDN Verizon Premium プロファイルの場合は、通常、10 分で完了しま
- Azure CDN Akamai Standard プロファイルは、通常、1 分で伝達されます
